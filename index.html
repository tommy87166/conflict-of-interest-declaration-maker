<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººåˆ©ç›Šè¡çªè¿´é¿è²æ˜æ›¸è¡¨æ ¼ç”¢ç”Ÿå·¥å…·</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif;
            background: #f0f2f5; color: #333; min-height: 100vh;
        }
        .container { max-width: 100%; margin: 0 auto; padding: 24px 32px; }
        h1 { text-align: center; color: #1a365d; margin-bottom: 6px; font-size: 26px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 28px; font-size: 14px; }

        /* Upload */
        .upload-area {
            background: #fff; border: 2px dashed #cbd5e0; border-radius: 12px;
            padding: 36px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 16px;
        }
        .upload-area:hover, .upload-area.dragover { border-color: #4299e1; background: #ebf8ff; }
        .upload-area .icon { font-size: 40px; margin-bottom: 8px; }
        .upload-area p { font-size: 15px; color: #666; }
        .upload-area .hint { font-size: 13px; color: #999; margin-top: 4px; }
        input[type="file"] { display: none; }

        /* File info bar */
        .file-info {
            background: #fff; border-radius: 12px; padding: 14px 24px; margin-bottom: 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-info .name { font-weight: 600; color: #2d3748; }
        .file-info .badge { background: #c6f6d5; color: #276749; padding: 3px 10px; border-radius: 4px; font-size: 13px; margin-left: 12px; }
        .btn-sm {
            background: #e2e8f0; border: none; padding: 7px 14px; border-radius: 6px;
            cursor: pointer; font-size: 13px; font-family: inherit;
        }
        .btn-sm:hover { background: #cbd5e0; }

        /* Section card */
        .section {
            background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 {
            font-size: 17px; color: #2d3748; margin-bottom: 16px;
            padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;
        }
        .section h2 .step-badge {
            display: inline-block; background: #4299e1; color: #fff; font-size: 13px;
            padding: 2px 10px; border-radius: 10px; margin-right: 8px; vertical-align: middle;
        }

        /* Form fields */
        .form-row { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 13px; font-weight: 600; color: #4a5568; }
        .form-group input, .form-group textarea {
            padding: 8px 12px; border: 1px solid #d2d6dc; border-radius: 6px;
            font-size: 14px; font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none; border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66,153,225,0.15);
        }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 12px; color: #999; margin-top: 2px; }

        /* Buttons */
        .btn {
            border: none; padding: 10px 28px; border-radius: 8px; font-size: 15px;
            font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit;
        }
        .btn-primary { background: #4299e1; color: #fff; }
        .btn-primary:hover { background: #3182ce; }
        .btn-green { background: #48bb78; color: #fff; }
        .btn-green:hover { background: #38a169; }
        .btn-orange { background: #ed8936; color: #fff; }
        .btn-orange:hover { background: #dd6b20; }
        .btn-copy { background: #805ad5; color: #fff; padding: 12px 36px; font-size: 16px; }
        .btn-copy:hover { background: #6b46c1; }
        .btn-copy.copied { background: #38a169; }
        .btn-group { display: flex; gap: 12px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }

        /* Tables */
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 9px 14px; text-align: left; border: 1px solid #e2e8f0; white-space: nowrap; }
        th { background: #edf2f7; font-weight: 600; color: #2d3748; position: sticky; top: 0; }

        .result-table th { background: #2d3748; color: #fff; }
        .result-table .before-eff { background: #fed7d7; }
        .result-table .after-eff { background: #c6f6d5; }

        .preview-container { max-height: 300px; overflow: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .preview-container table { font-size: 12px; }
        .preview-container th { font-size: 12px; }

        /* Alert boxes */
        .alert {
            margin-top: 12px; padding: 12px 16px; border-radius: 8px; font-size: 13px;
        }
        .alert-red { background: #fff5f5; border: 1px solid #fed7d7; color: #c53030; }
        .alert-orange { background: #fffaf0; border: 1px solid #feebc8; color: #c05621; }
        .alert-blue { background: #ebf8ff; border: 1px solid #bee3f8; color: #2b6cb0; }
        .alert-green { background: #f0fff4; border: 1px solid #c6f6d5; color: #276749; }
        .alert strong { display: block; margin-bottom: 4px; }

        /* Summary cards */
        .summary-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px; margin-bottom: 20px;
        }
        .summary-card {
            background: #fff; border-radius: 10px; padding: 16px; text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .summary-card .number { font-size: 32px; font-weight: 700; margin-bottom: 2px; }
        .summary-card .label { font-size: 13px; color: #666; }
        .summary-card.blue .number { color: #3182ce; }
        .summary-card.green .number { color: #38a169; }

        /* Word table â€” 5.33cm per col, 1.66cm row height */
        .word-table { margin-top: 16px; }
        .word-table table { border: 2px solid #333; table-layout: fixed; width: 604px; }
        .word-table th { background: #f0f0f0; color: #333; border: 1.5px solid #333; text-align: center; font-size: 15px; width: 201px; height: 63px; padding: 4px 8px; }
        .word-table td { border: 1.5px solid #333; text-align: center; font-size: 15px; width: 201px; height: 63px; padding: 4px 8px; }

        .hidden { display: none; }

        .parsed-info {
            background: #f7fafc; border-radius: 8px; padding: 14px 18px;
            margin-bottom: 16px; font-size: 13px; color: #4a5568; line-height: 1.8;
        }
        .parsed-info strong { color: #2d3748; }

        .no-custom-msg {
            padding: 16px; text-align: center; color: #718096; font-size: 14px;
            background: #f7fafc; border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å€‹äººåˆ©ç›Šè¡çªè¿´é¿è²æ˜æ›¸è¡¨æ ¼ç”¢ç”Ÿå·¥å…·</h1>
        <p class="subtitle">ä¸Šå‚³ Timesheet èˆ‡è‡ªè¨‚åå–®ï¼Œè‡ªå‹•åˆ¤æ–·æ¯äººè²æ˜æ›¸ç°½ç½²æ—¥æœŸ</p>

        <!-- ==================== Step 1 ==================== -->
        <div class="section">
            <h2><span class="step-badge">æ­¥é©Ÿ 1</span>ä¸Šå‚³ Timesheet</h2>

            <div id="uploadArea1" class="upload-area">
                <div class="icon">ğŸ“‚</div>
                <p>è«‹ä¸Šå‚³ EIS ä¸­ Time Cost detail group by Client/Job å ±è¡¨</p>
                <p class="hint">æ”¯æ´ .xlsx, .xlsï¼ˆè‡ªå‹•è®€å– Sheet1 çš„ Staff Name èˆ‡ Timesheet Dateï¼‰</p>
                <input type="file" id="fileInput1" accept=".xlsx,.xls">
            </div>

            <div id="fileInfo1" class="file-info hidden">
                <div>
                    <span class="name" id="fileName1"></span>
                    <span class="badge" id="parsedCount1"></span>
                </div>
                <button class="btn-sm" onclick="resetStep1()">é‡æ–°ä¸Šå‚³</button>
            </div>

            <div id="previewSection1" class="hidden">
                <div id="parsedInfo1" class="parsed-info"></div>
                <details>
                    <summary style="cursor:pointer; font-size:13px; color:#4299e1; margin-bottom:8px;">å±•é–‹è³‡æ–™é è¦½</summary>
                    <div id="previewContainer1" class="preview-container"></div>
                </details>
            </div>
        </div>

        <!-- ==================== Step 2 ==================== -->
        <div class="section">
            <h2><span class="step-badge">æ­¥é©Ÿ 2</span>è¼¸å…¥ A&amp;C å®Œæˆæ—¥ &amp; è‡ªè¨‚åå–®</h2>

            <div class="form-row">
                <div class="form-group">
                    <label>A&amp;C å®Œæˆæ—¥</label>
                    <input type="date" id="acDateInput">
                </div>
            </div>

            <div class="form-group" style="margin-top: 8px;">
                <label>è‡ªè¨‚åå–®ï¼ˆå¦‚ï¼šä¸åœ¨ Timesheetï¼Œä½†æœ‰åœ¨ EMW ä¸­äººå“¡ã€‚ï¼‰</label>
                <textarea id="customNamesInput" placeholder="ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šç‹å°æ˜, æå¤§è¯, å¼µç¾ç²"></textarea>
                <span class="form-hint">å¦‚å§“åèˆ‡ Timesheet é‡è¤‡ï¼Œä»¥ Timesheet ç‚ºä¸»ï¼ˆé‡è¤‡è€…å°‡é¡¯ç¤ºæ–¼æ’é™¤æ¸…å–®ï¼‰</span>
            </div>

            <div id="dupCustomAlert" class="alert alert-orange hidden">
                <strong>ä»¥ä¸‹è‡ªè¨‚åå–®å§“åé‡è¤‡è¼¸å…¥ï¼Œå·²è‡ªå‹•å»é‡ï¼š</strong>
                <span id="dupCustomNames"></span>
            </div>

            <div id="excludedAlert" class="alert alert-red hidden">
                <strong>ä»¥ä¸‹è‡ªè¨‚åå–®å§“åèˆ‡ Timesheet é‡è¤‡ï¼Œå·²æ’é™¤ï¼ˆä»¥ Timesheet ç‚ºä¸»ï¼‰ï¼š</strong>
                <span id="excludedNames"></span>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="processStep2()">è™•ç†åå–®</button>
            </div>
        </div>

        <!-- ==================== Step 3 ==================== -->
        <div id="step3Section" class="section hidden">
            <h2><span class="step-badge">æ­¥é©Ÿ 3</span>è£œå¡«åˆ°è·æ—¥</h2>

            <div id="step3HasCustom">
                <div class="alert alert-blue">
                    <strong>ä»¥ä¸‹äººå“¡åƒ…å‡ºç¾åœ¨è‡ªè¨‚åå–®ä¸­ï¼ˆä¸åœ¨ Timesheetï¼‰ï¼Œéœ€è£œå¡«åˆ°è·æ—¥ï¼š</strong>
                    <span id="customOnlyNames"></span>
                </div>

                <div class="btn-group" style="margin-top: 16px; margin-bottom: 16px;">
                    <button class="btn btn-orange" onclick="downloadHireDateTemplate()">ä¸‹è¼‰åˆ°è·æ—¥å¡«å¯«ç¯„æœ¬ (Excel)</button>
                </div>
            </div>

            <div id="step3NoCustom" class="no-custom-msg hidden">
                æ‰€æœ‰è‡ªè¨‚åå–®äººå“¡çš†å·²åœ¨ Timesheet ä¸­ï¼Œç„¡éœ€è£œå¡«åˆ°è·æ—¥ã€‚
            </div>
        </div>

        <!-- ==================== Step 4 ==================== -->
        <div id="step4Section" class="section hidden">
            <h2><span class="step-badge">æ­¥é©Ÿ 4</span>ä¸Šå‚³åˆ°è·æ—¥è³‡æ–™</h2>

            <div id="uploadArea4" class="upload-area">
                <div class="icon">ğŸ“„</div>
                <p>è«‹ä¸Šå‚³å¡«å¯«å®Œæˆçš„åˆ°è·æ—¥ Excel</p>
                <p class="hint">å³æ­¥é©Ÿ 3 ä¸‹è¼‰ä¸¦å¡«å¯«å¾Œçš„æª”æ¡ˆ</p>
                <input type="file" id="fileInput4" accept=".xlsx,.xls">
            </div>

            <div id="fileInfo4" class="file-info hidden">
                <div>
                    <span class="name" id="fileName4"></span>
                    <span class="badge" id="parsedCount4"></span>
                </div>
                <button class="btn-sm" onclick="resetStep4()">é‡æ–°ä¸Šå‚³</button>
            </div>

            <div id="hireDatePreview" class="hidden" style="margin-top: 12px;">
                <div class="table-wrapper">
                    <table id="hireDateTable"></table>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="generateResults()">ç”¢ç”Ÿæ¯”è¼ƒçµæœ</button>
            </div>
        </div>

        <!-- ==================== Step 5 ==================== -->
        <div id="step5Section" class="section hidden">
            <h2><span class="step-badge">æ­¥é©Ÿ 5</span>ä¾†æº 1ï¼šTimesheet äººå“¡çµæœ</h2>
            <p style="font-size:13px; color:#718096; margin-bottom:10px;">
                æ¯”è¼ƒ Timesheet ç¬¬ä¸€å¤©èˆ‡è¦å®šç”Ÿæ•ˆæ—¥ <strong>2025/07/01</strong>ï¼Œè‹¥åœ¨ç”Ÿæ•ˆæ—¥å‰å‰‡æ”¹å£“ 2025/07/01
            </p>
            <div id="summary5" class="summary-cards"></div>
            <div class="table-wrapper">
                <table id="resultTable5" class="result-table"></table>
            </div>
        </div>

        <!-- ==================== Step 6 ==================== -->
        <div id="step6Section" class="section hidden">
            <h2><span class="step-badge">æ­¥é©Ÿ 6</span>ä¾†æº 2ï¼šè‡ªè¨‚åå–®äººå“¡çµæœ</h2>
            <p style="font-size:13px; color:#718096; margin-bottom:10px;">
                å–ã€Œåˆ°è·æ—¥ã€ã€ã€ŒA&amp;C å®Œæˆæ—¥ã€ã€ã€Œè¦å®šç”Ÿæ•ˆæ—¥ 2025/07/01ã€ä¸‰è€…ä¸­<strong>æœ€æ™š</strong>çš„æ—¥æœŸ
            </p>
            <div id="summary6" class="summary-cards"></div>
            <div class="table-wrapper">
                <table id="resultTable6" class="result-table"></table>
            </div>
        </div>

        <!-- ==================== Step 7 ==================== -->
        <div id="step7Section" class="section hidden">
            <h2><span class="step-badge">æ­¥é©Ÿ 7</span>è²æ˜è¡¨æ ¼ï¼ˆè¤‡è£½åˆ° Wordï¼‰</h2>

            <div class="btn-group" style="margin-bottom: 12px;">
                <button class="btn btn-green" onclick="confirmAndGenerate()">ç¢ºèªï¼Œç”¢ç”Ÿè²æ˜è¡¨æ ¼</button>
            </div>

            <div id="finalTableWrapper" class="hidden">
                <div class="word-table">
                    <div class="table-wrapper">
                        <table id="finalTable"></table>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-copy" id="copyBtn" onclick="copyFinalTable()">ä¸€éµè¤‡è£½è¡¨æ ¼</button>
                    <button class="btn btn-green" onclick="exportFinalExcel()">åŒ¯å‡º Excel</button>
                </div>
                <p style="margin-top: 12px; font-size: 13px; color: #718096; text-align: center;">
                    æ–¼ Word è²¼ä¸Šè¡¨æ ¼æ™‚ï¼Œè«‹æŒ‰è²¼ä¸ŠæŒ‰éˆ•ä¸‹æ–¹ã€Œ<strong>V</strong>ã€ï¼Œä¸¦é¸æ“‡å·¦é‚Šç¬¬ä¸€å€‹ã€Œ<strong>ä¿ç•™ä¾†æºæ ¼å¼è¨­å®š</strong>ã€
                </p>
            </div>
        </div>
    </div>

    <script>
        // ========== Constants ==========
        const EFFECTIVE_DATE = new Date(2025, 6, 1); // 2025/07/01

        // ========== State ==========
        let parsedPeople = {};      // { name: earliestTimesheetDate }
        let customOnlyList = [];    // names only in custom list (not in Timesheet)
        let hireDateData = {};      // { name: hireDate }
        let acDate = null;
        let source1Results = [];
        let source2Results = [];

        // ========== Step 1: Upload Timesheet ==========
        const uploadArea1 = document.getElementById('uploadArea1');
        const fileInput1 = document.getElementById('fileInput1');
        uploadArea1.addEventListener('click', () => fileInput1.click());
        uploadArea1.addEventListener('dragover', e => { e.preventDefault(); uploadArea1.classList.add('dragover'); });
        uploadArea1.addEventListener('dragleave', () => uploadArea1.classList.remove('dragover'));
        uploadArea1.addEventListener('drop', e => {
            e.preventDefault(); uploadArea1.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile1(e.dataTransfer.files[0]);
        });
        fileInput1.addEventListener('change', e => { if (e.target.files.length) handleFile1(e.target.files[0]); });

        function handleFile1(file) {
            if (!/\.(xlsx|xls)$/i.test(file.name)) { alert('è«‹ä¸Šå‚³ .xlsx æˆ– .xls æ ¼å¼çš„æª”æ¡ˆ'); return; }
            document.getElementById('fileName1').textContent = file.name;
            uploadArea1.classList.add('hidden');
            document.getElementById('fileInfo1').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = e => {
                const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                parseTimesheet(wb);
            };
            reader.readAsArrayBuffer(file);
        }

        function resetStep1() {
            parsedPeople = {};
            fileInput1.value = '';
            uploadArea1.classList.remove('hidden');
            document.getElementById('fileInfo1').classList.add('hidden');
            document.getElementById('previewSection1').classList.add('hidden');
            hideSteps(3);
        }

        function parseTimesheet(wb) {
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', dateNF: 'yyyy-mm-dd' });

            if (rows.length < 2) { alert('Sheet1 è³‡æ–™ä¸è¶³'); return; }

            const headers = rows[0].map(h => String(h).trim());
            const nameIdx = headers.findIndex(h => /staff\s*name/i.test(h));
            const dateIdx = headers.findIndex(h => /timesheet\s*date/i.test(h));

            if (nameIdx === -1) { alert('æ‰¾ä¸åˆ° "Staff Name" æ¬„ä½ï¼Œè«‹ç¢ºèª Sheet1 æ¨™é¡Œåˆ—'); return; }
            if (dateIdx === -1) { alert('æ‰¾ä¸åˆ° "Timesheet Date" æ¬„ä½ï¼Œè«‹ç¢ºèª Sheet1 æ¨™é¡Œåˆ—'); return; }

            parsedPeople = {};
            let totalRows = 0;

            for (let r = 1; r < rows.length; r++) {
                const row = rows[r];
                const name = row[nameIdx] != null ? String(row[nameIdx]).trim() : '';
                if (!name) continue;
                const dateVal = parseDate(row[dateIdx]);
                if (!dateVal) continue;
                totalRows++;
                if (!parsedPeople[name] || dateVal < parsedPeople[name]) {
                    parsedPeople[name] = dateVal;
                }
            }

            const peopleCount = Object.keys(parsedPeople).length;
            document.getElementById('parsedCount1').textContent = `${peopleCount} äºº / ${totalRows} ç­†`;
            document.getElementById('parsedInfo1').innerHTML =
                `<strong>å·¥ä½œè¡¨ï¼š</strong>${esc(sheetName)}ã€€|ã€€` +
                `<strong>Staff Nameï¼š</strong>ç¬¬ ${nameIdx + 1} æ¬„ã€€|ã€€` +
                `<strong>Timesheet Dateï¼š</strong>ç¬¬ ${dateIdx + 1} æ¬„ã€€|ã€€` +
                `<strong>è§£æçµæœï¼š</strong>${peopleCount} ä½äººå“¡ï¼Œå…± ${totalRows} ç­†è¨˜éŒ„`;

            let previewHtml = '<table><thead><tr><th>åˆ—</th><th>Staff Name</th><th>Timesheet Date</th></tr></thead><tbody>';
            const previewEnd = Math.min(31, rows.length);
            for (let r = 1; r < previewEnd; r++) {
                const row = rows[r];
                const n = row[nameIdx] != null ? String(row[nameIdx]).trim() : '';
                const d = formatCellValue(row[dateIdx]);
                previewHtml += `<tr><td>${r + 1}</td><td>${esc(n)}</td><td>${esc(d)}</td></tr>`;
            }
            if (rows.length > previewEnd) {
                previewHtml += `<tr><td colspan="3" style="text-align:center;color:#999;font-style:italic;">... é‚„æœ‰ ${rows.length - previewEnd} åˆ— ...</td></tr>`;
            }
            previewHtml += '</tbody></table>';
            document.getElementById('previewContainer1').innerHTML = previewHtml;
            document.getElementById('previewSection1').classList.remove('hidden');
        }

        // ========== Step 2: Process custom names ==========
        function processStep2() {
            const acDateStr = document.getElementById('acDateInput').value;
            if (!acDateStr) { alert('è«‹é¸æ“‡ A&C å®Œæˆæ—¥'); return; }
            if (Object.keys(parsedPeople).length === 0) { alert('è«‹å…ˆä¸Šå‚³ Timesheet Excel'); return; }

            acDate = new Date(acDateStr + 'T00:00:00');

            const customInput = document.getElementById('customNamesInput').value.trim();
            const tsNames = new Set(Object.keys(parsedPeople));
            const dupCustomNames = [];
            const excludedNames = [];
            customOnlyList = [];

            if (customInput) {
                const rawNames = customInput.split(/[,ï¼Œã€\n]+/).map(s => s.trim()).filter(s => s);
                const seen = new Set();
                for (const name of rawNames) {
                    if (seen.has(name)) {
                        if (!dupCustomNames.includes(name)) dupCustomNames.push(name);
                        continue;
                    }
                    seen.add(name);
                    if (tsNames.has(name)) {
                        excludedNames.push(name);
                    } else {
                        customOnlyList.push(name);
                    }
                }
            }

            // Show duplicate alert
            const dupEl = document.getElementById('dupCustomAlert');
            if (dupCustomNames.length > 0) {
                document.getElementById('dupCustomNames').textContent = dupCustomNames.join('ã€');
                dupEl.classList.remove('hidden');
            } else { dupEl.classList.add('hidden'); }

            // Show excluded alert
            const exEl = document.getElementById('excludedAlert');
            if (excludedNames.length > 0) {
                document.getElementById('excludedNames').textContent = excludedNames.join('ã€');
                exEl.classList.remove('hidden');
            } else { exEl.classList.add('hidden'); }

            // Show step 3
            const step3 = document.getElementById('step3Section');
            step3.classList.remove('hidden');

            if (customOnlyList.length > 0) {
                document.getElementById('customOnlyNames').textContent = customOnlyList.join('ã€');
                document.getElementById('step3HasCustom').classList.remove('hidden');
                document.getElementById('step3NoCustom').classList.add('hidden');
                document.getElementById('step4Section').classList.remove('hidden');
                // Hide results until step 4 upload
                hideSteps(5);
            } else {
                document.getElementById('step3HasCustom').classList.add('hidden');
                document.getElementById('step3NoCustom').classList.remove('hidden');
                document.getElementById('step4Section').classList.add('hidden');
                // No custom-only people, go directly to results
                hireDateData = {};
                generateResults();
            }

            step3.scrollIntoView({ behavior: 'smooth' });
        }

        // ========== Step 3: Download template ==========
        function downloadHireDateTemplate() {
            const data = [['å§“å', 'åˆ°è·æ—¥(è¥¿å…ƒå¹´/æœˆ/æ—¥)']];
            customOnlyList.forEach(name => data.push([name, '']));

            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 20 }, { wch: 16 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'åˆ°è·æ—¥');
            XLSX.writeFile(wb, 'åˆ°è·æ—¥å¡«å¯«ç¯„æœ¬.xlsx');
        }

        // ========== Step 4: Upload hire date ==========
        const uploadArea4 = document.getElementById('uploadArea4');
        const fileInput4 = document.getElementById('fileInput4');
        uploadArea4.addEventListener('click', () => fileInput4.click());
        uploadArea4.addEventListener('dragover', e => { e.preventDefault(); uploadArea4.classList.add('dragover'); });
        uploadArea4.addEventListener('dragleave', () => uploadArea4.classList.remove('dragover'));
        uploadArea4.addEventListener('drop', e => {
            e.preventDefault(); uploadArea4.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile4(e.dataTransfer.files[0]);
        });
        fileInput4.addEventListener('change', e => { if (e.target.files.length) handleFile4(e.target.files[0]); });

        function handleFile4(file) {
            if (!/\.(xlsx|xls)$/i.test(file.name)) { alert('è«‹ä¸Šå‚³ .xlsx æˆ– .xls æ ¼å¼çš„æª”æ¡ˆ'); return; }
            document.getElementById('fileName4').textContent = file.name;
            uploadArea4.classList.add('hidden');
            document.getElementById('fileInfo4').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = e => {
                const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                parseHireDateFile(wb);
            };
            reader.readAsArrayBuffer(file);
        }

        function resetStep4() {
            hireDateData = {};
            fileInput4.value = '';
            uploadArea4.classList.remove('hidden');
            document.getElementById('fileInfo4').classList.add('hidden');
            document.getElementById('hireDatePreview').classList.add('hidden');
            hideSteps(5);
        }

        function parseHireDateFile(wb) {
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', dateNF: 'yyyy-mm-dd' });

            if (rows.length < 2) { alert('åˆ°è·æ—¥æª”æ¡ˆè³‡æ–™ä¸è¶³'); return; }

            const headers = rows[0].map(h => String(h).trim());
            const nameIdx = headers.findIndex(h => /å§“å|name/i.test(h));
            const dateIdx = headers.findIndex(h => /åˆ°è·/i.test(h));

            if (nameIdx === -1 || dateIdx === -1) {
                alert('æ‰¾ä¸åˆ°ã€Œå§“åã€æˆ–ã€Œåˆ°è·æ—¥ã€æ¬„ä½ï¼Œè«‹ç¢ºèªæ ¼å¼'); return;
            }

            hireDateData = {};
            let count = 0;
            for (let r = 1; r < rows.length; r++) {
                const row = rows[r];
                const name = row[nameIdx] != null ? String(row[nameIdx]).trim() : '';
                if (!name) continue;
                const d = parseDate(row[dateIdx]);
                if (d) { hireDateData[name] = d; count++; }
            }

            document.getElementById('parsedCount4').textContent = `${count} äºº`;

            // Preview
            let html = '<table class="result-table"><thead><tr><th>#</th><th>å§“å</th><th>åˆ°è·æ—¥</th></tr></thead><tbody>';
            let i = 0;
            for (const [name, d] of Object.entries(hireDateData)) {
                html += `<tr><td>${++i}</td><td>${esc(name)}</td><td>${fmtDate(d)}</td></tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('hireDateTable').outerHTML = `<table id="hireDateTable">${html}</table>`;
            document.getElementById('hireDatePreview').classList.remove('hidden');
        }

        // ========== Step 5 & 6: Generate results ==========
        function generateResults() {
            source1Results = [];
            source2Results = [];

            // Source 1: Timesheet people
            for (const [name, firstDate] of Object.entries(parsedPeople)) {
                const beforeEffective = firstDate < EFFECTIVE_DATE;
                const finalDate = beforeEffective ? EFFECTIVE_DATE : firstDate;

                source1Results.push({ name, firstDate, beforeEffective, finalDate });
            }

            // Source 2: Custom-only people
            for (const name of customOnlyList) {
                const hireDate = hireDateData[name] || null;
                const candidates = [EFFECTIVE_DATE];
                if (acDate) candidates.push(acDate);
                if (hireDate) candidates.push(hireDate);

                // Pick the latest
                let latest = candidates[0];
                let latestType = 'è¦å®šç”Ÿæ•ˆæ—¥';
                for (const d of candidates) {
                    if (d >= latest) { latest = d; }
                }

                // Determine which type it is
                if (hireDate && latest.getTime() === hireDate.getTime()) {
                    latestType = 'åˆ°è·æ—¥';
                } else if (acDate && latest.getTime() === acDate.getTime()) {
                    latestType = 'A&C å®Œæˆæ—¥';
                } else {
                    latestType = 'è¦å®šç”Ÿæ•ˆæ—¥';
                }

                source2Results.push({ name, hireDate, acDate, latestType, finalDate: latest });
            }

            displaySource1();
            displaySource2();

            // Show step 7
            document.getElementById('step7Section').classList.remove('hidden');
            document.getElementById('finalTableWrapper').classList.add('hidden');

            document.getElementById('step5Section').scrollIntoView({ behavior: 'smooth' });
        }

        function displaySource1() {
            const section = document.getElementById('step5Section');
            section.classList.remove('hidden');

            const total = source1Results.length;
            const adjusted = source1Results.filter(r => r.beforeEffective).length;

            document.getElementById('summary5').innerHTML = `
                <div class="summary-card blue"><div class="number">${total}</div><div class="label">Timesheet äººæ•¸</div></div>
                <div class="summary-card green"><div class="number">${total - adjusted}</div><div class="label">ç”Ÿæ•ˆæ—¥å¾Œï¼ˆä¸èª¿æ•´ï¼‰</div></div>
                <div class="summary-card" style="border:1px solid #fed7d7;"><div class="number" style="color:#e53e3e;">${adjusted}</div><div class="label">ç”Ÿæ•ˆæ—¥å‰ï¼ˆæ”¹å£“ 07/01ï¼‰</div></div>
            `;

            let html = `<thead><tr>
                <th>#</th><th>å§“å</th><th>Timesheet ç¬¬ä¸€å¤©</th>
                <th>åœ¨è¦å®šç”Ÿæ•ˆæ—¥å‰/å¾Œ</th><th>æœ€çµ‚æ±ºå®šç°½ç½²æ—¥æœŸ</th>
            </tr></thead><tbody>`;

            source1Results.forEach((r, i) => {
                const cls = r.beforeEffective ? 'before-eff' : 'after-eff';
                const note = r.beforeEffective
                    ? '<span style="color:#c53030;">ç”Ÿæ•ˆæ—¥å‰ â†’ æ”¹å£“ 2025/07/01</span>'
                    : '<span style="color:#276749;">ç”Ÿæ•ˆæ—¥å¾Œï¼ˆä¸èª¿æ•´ï¼‰</span>';
                html += `<tr class="${cls}">
                    <td>${i + 1}</td><td>${esc(r.name)}</td>
                    <td>${fmtDate(r.firstDate)}</td>
                    <td>${note}</td>
                    <td><strong>${fmtDate(r.finalDate)}</strong></td>
                </tr>`;
            });
            html += '</tbody>';
            document.getElementById('resultTable5').innerHTML = html;
        }

        function displaySource2() {
            const section = document.getElementById('step6Section');
            if (source2Results.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');

            const total = source2Results.length;
            document.getElementById('summary6').innerHTML = `
                <div class="summary-card blue"><div class="number">${total}</div><div class="label">è‡ªè¨‚åå–®äººæ•¸</div></div>
            `;

            let html = `<thead><tr>
                <th>#</th><th>å§“å</th><th>åˆ°è·æ—¥</th><th>A&amp;C å®Œæˆæ—¥</th>
                <th>è¦å®šç”Ÿæ•ˆæ—¥</th><th>æ¡ç”¨æ—¥æœŸç¨®é¡</th><th>æœ€çµ‚æ±ºå®šç°½ç½²æ—¥æœŸ</th>
            </tr></thead><tbody>`;

            source2Results.forEach((r, i) => {
                html += `<tr>
                    <td>${i + 1}</td><td>${esc(r.name)}</td>
                    <td>${r.hireDate ? fmtDate(r.hireDate) : '<span style="color:#e53e3e;">æœªå¡«</span>'}</td>
                    <td>${fmtDate(r.acDate)}</td>
                    <td>${fmtDate(EFFECTIVE_DATE)}</td>
                    <td><strong>${r.latestType}</strong></td>
                    <td><strong>${fmtDate(r.finalDate)}</strong></td>
                </tr>`;
            });
            html += '</tbody>';
            document.getElementById('resultTable6').innerHTML = html;
        }

        // ========== Step 7: Final Word table ==========
        function confirmAndGenerate() {
            const allResults = [...source1Results, ...source2Results];
            if (allResults.length === 0) return;

            const CW = 201; const RH = 63;
            let html = `<thead><tr height="${RH}">
                <th width="${CW}" height="${RH}">è²æ˜äººå§“å</th>
                <th width="${CW}" height="${RH}">ç°½ç« </th>
                <th width="${CW}" height="${RH}">æ—¥æœŸ</th>
            </tr></thead><tbody>`;

            allResults.forEach(r => {
                html += `<tr height="${RH}">
                    <td width="${CW}" height="${RH}">${esc(r.name)}</td>
                    <td width="${CW}" height="${RH}"></td>
                    <td width="${CW}" height="${RH}">${fmtDate(r.finalDate)}</td>
                </tr>`;
            });
            html += '</tbody>';

            document.getElementById('finalTable').innerHTML = html;
            document.getElementById('finalTableWrapper').classList.remove('hidden');
            document.getElementById('copyBtn').textContent = 'ä¸€éµè¤‡è£½è¡¨æ ¼';
            document.getElementById('copyBtn').classList.remove('copied');
            document.getElementById('finalTableWrapper').scrollIntoView({ behavior: 'smooth' });

            window._allResults = allResults;
        }

        function copyFinalTable() {
            const table = document.getElementById('finalTable');
            const range = document.createRange();
            range.selectNode(table);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            try {
                document.execCommand('copy');
                const btn = document.getElementById('copyBtn');
                btn.textContent = 'å·²è¤‡è£½!';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'ä¸€éµè¤‡è£½è¡¨æ ¼'; btn.classList.remove('copied'); }, 2000);
            } catch (e) { alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¡¨æ ¼å¾Œè¤‡è£½'); }
            sel.removeAllRanges();
        }

        function exportFinalExcel() {
            if (!window._allResults) return;
            const data = [['è²æ˜äººå§“å', 'ç°½ç« ', 'æ—¥æœŸ']];
            window._allResults.forEach(r => data.push([r.name, '', fmtDate(r.finalDate)]));
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 14 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è²æ˜è¡¨æ ¼');
            XLSX.writeFile(wb, 'åˆ©å®³é—œä¿‚è²æ˜è¡¨æ ¼.xlsx');
        }

        // ========== Helpers ==========
        function hideSteps(fromStep) {
            if (fromStep <= 3) document.getElementById('step3Section').classList.add('hidden');
            if (fromStep <= 4) document.getElementById('step4Section').classList.add('hidden');
            if (fromStep <= 5) document.getElementById('step5Section').classList.add('hidden');
            if (fromStep <= 6) document.getElementById('step6Section').classList.add('hidden');
            if (fromStep <= 7) {
                document.getElementById('step7Section').classList.add('hidden');
            }
        }

        function parseDate(val) {
            if (val == null || val === '') return null;
            if (val instanceof Date) return isNaN(val.getTime()) ? null : val;
            const s = String(val).trim();
            let m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            if (m) return new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]));
            if (/^\d{5}(\.\d+)?$/.test(s)) {
                const num = parseFloat(s);
                if (num > 30000 && num < 60000) return new Date((num - 25569) * 86400 * 1000);
            }
            m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
            if (m) return new Date(parseInt(m[3]), parseInt(m[1]) - 1, parseInt(m[2]));
            const d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        }

        function fmtDate(d) {
            if (!d || !(d instanceof Date)) return '';
            return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
        }

        function formatCellValue(val) {
            if (val == null) return '';
            if (val instanceof Date) return fmtDate(val);
            return String(val);
        }

        function esc(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }
    </script>
</body>
</html>
