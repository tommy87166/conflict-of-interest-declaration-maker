<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººåˆ©ç›Šè¡çªè¿´é¿è²æ˜æ›¸è¡¨æ ¼ç”¢ç”Ÿå·¥å…·</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }
        .container { max-width: 100%; margin: 0 auto; padding: 24px 32px; }
        h1 { text-align: center; color: #1a365d; margin-bottom: 6px; font-size: 26px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 28px; font-size: 14px; }

        /* Upload */
        .upload-area {
            background: #fff; border: 2px dashed #cbd5e0; border-radius: 12px;
            padding: 44px; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 24px;
        }
        .upload-area:hover, .upload-area.dragover { border-color: #4299e1; background: #ebf8ff; }
        .upload-area .icon { font-size: 44px; margin-bottom: 10px; }
        .upload-area p { font-size: 15px; color: #666; }
        .upload-area .hint { font-size: 13px; color: #999; margin-top: 6px; }
        input[type="file"] { display: none; }

        /* File info bar */
        .file-info {
            background: #fff; border-radius: 12px; padding: 14px 24px; margin-bottom: 24px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-info .name { font-weight: 600; color: #2d3748; }
        .file-info .badge { background: #c6f6d5; color: #276749; padding: 3px 10px; border-radius: 4px; font-size: 13px; margin-left: 12px; }
        .btn-sm {
            background: #e2e8f0; border: none; padding: 7px 14px; border-radius: 6px;
            cursor: pointer; font-size: 13px; font-family: inherit;
        }
        .btn-sm:hover { background: #cbd5e0; }

        /* Section card */
        .section {
            background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 {
            font-size: 17px; color: #2d3748; margin-bottom: 16px;
            padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;
        }

        /* Form fields */
        .form-row { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 13px; font-weight: 600; color: #4a5568; }
        .form-group input, .form-group textarea {
            padding: 8px 12px; border: 1px solid #d2d6dc; border-radius: 6px;
            font-size: 14px; font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none; border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66,153,225,0.15);
        }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .form-hint { font-size: 12px; color: #999; margin-top: 2px; }

        /* Buttons */
        .btn {
            border: none; padding: 10px 28px; border-radius: 8px; font-size: 15px;
            font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit;
        }
        .btn-primary { background: #4299e1; color: #fff; }
        .btn-primary:hover { background: #3182ce; }
        .btn-green { background: #48bb78; color: #fff; }
        .btn-green:hover { background: #38a169; }
        .btn-copy {
            background: #805ad5; color: #fff; padding: 12px 36px; font-size: 16px;
        }
        .btn-copy:hover { background: #6b46c1; }
        .btn-copy.copied { background: #38a169; }
        .btn-group { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }

        /* Tables */
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 9px 14px; text-align: left; border: 1px solid #e2e8f0; white-space: nowrap; }
        th { background: #edf2f7; font-weight: 600; color: #2d3748; position: sticky; top: 0; }

        .result-table th { background: #2d3748; color: #fff; }
        .result-table .earlier-timesheet { background: #fed7d7; }
        .result-table .earlier-ac { background: #c6f6d5; }
        .result-table .same-date { background: #fefcbf; }
        .result-table .custom-row { background: #e9d8fd; }

        .preview-container { max-height: 300px; overflow: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .preview-container table { font-size: 12px; }
        .preview-container th { font-size: 12px; }

        /* Summary cards */
        .summary-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px; margin-bottom: 20px;
        }
        .summary-card {
            background: #fff; border-radius: 10px; padding: 16px; text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .summary-card .number { font-size: 32px; font-weight: 700; margin-bottom: 2px; }
        .summary-card .label { font-size: 13px; color: #666; }
        .summary-card.blue .number { color: #3182ce; }
        .summary-card.red .number { color: #e53e3e; }
        .summary-card.green .number { color: #38a169; }
        .summary-card.yellow .number { color: #d69e2e; }
        .summary-card.purple .number { color: #805ad5; }

        /* Legend */
        .legend { display: flex; gap: 20px; margin-bottom: 14px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; border: 1px solid #ccc; }

        /* Word table â€” 5.33cm per col, 1.66cm row height */
        .word-table { margin-top: 16px; }
        .word-table table { border: 2px solid #333; table-layout: fixed; width: 604px; /* 3 x ~201px â‰ˆ 3 x 5.33cm */ }
        .word-table th { background: #f0f0f0; color: #333; border: 1.5px solid #333; text-align: center; font-size: 15px; width: 201px; height: 63px; padding: 4px 8px; }
        .word-table td { border: 1.5px solid #333; text-align: center; font-size: 15px; width: 201px; height: 63px; padding: 4px 8px; }

        .hidden { display: none; }

        /* Parsed info */
        .parsed-info {
            background: #f7fafc; border-radius: 8px; padding: 14px 18px;
            margin-bottom: 16px; font-size: 13px; color: #4a5568; line-height: 1.8;
        }
        .parsed-info strong { color: #2d3748; }
    </style>
</head>
<body>
    <div class="container">
        <h1>å€‹äººåˆ©ç›Šè¡çªè¿´é¿è²æ˜æ›¸è¡¨æ ¼ç”¢ç”Ÿå·¥å…·</h1>
        <p class="subtitle">ä¸Šå‚³ Timesheet Excelï¼Œæ¯”è¼ƒæ¯äººç¬¬ä¸€å¤© Timesheet æ—¥æœŸèˆ‡ A&amp;C å®Œæˆæ—¥ï¼Œå–å­°æ—©è€…</p>

        <!-- Step 1: Upload + A&C Date + Custom Names -->
        <div class="section">
            <h2>æ­¥é©Ÿä¸€ï¼šä¸Šå‚³æª”æ¡ˆ &amp; è¨­å®š</h2>

            <div id="uploadArea" class="upload-area">
                <div class="icon">ğŸ“‚</div>
                <p>è«‹ä¸Šå‚³ EIS ä¸­ Time Cost detail group by Client/Job å ±è¡¨</p>
                <p class="hint">æ”¯æ´ .xlsx, .xlsï¼ˆè‡ªå‹•è®€å– Sheet1 çš„ Staff Name èˆ‡ Timesheet Dateï¼‰</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls">
            </div>

            <div id="fileInfo" class="file-info hidden">
                <div>
                    <span class="name" id="fileName"></span>
                    <span class="badge" id="parsedCount"></span>
                </div>
                <button class="btn-sm" onclick="resetAll()">é‡æ–°ä¸Šå‚³</button>
            </div>

            <!-- Preview -->
            <div id="previewSection" class="hidden">
                <div id="parsedInfo" class="parsed-info"></div>
                <details>
                    <summary style="cursor:pointer; font-size:13px; color:#4299e1; margin-bottom:8px;">å±•é–‹è³‡æ–™é è¦½</summary>
                    <div id="previewContainer" class="preview-container"></div>
                </details>
            </div>

            <div class="form-row" style="margin-top: 20px;">
                <div class="form-group">
                    <label>A&amp;C å®Œæˆæ—¥</label>
                    <input type="date" id="acDateInput">
                </div>
            </div>

            <div class="form-group" style="margin-top: 8px;">
                <label>è‡ªè¨‚åå–®ï¼ˆå¦‚ï¼šä¸åœ¨ Timesheetï¼Œä½†æœ‰åœ¨ EMW ä¸­äººå“¡ï¼Œæ—¥æœŸç›´æ¥å£“ A&amp;C å®Œæˆæ—¥ã€‚ï¼‰</label>
                <textarea id="customNamesInput" placeholder="ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ï¼šç‹å°æ˜, æå¤§è¯, å¼µç¾ç²"></textarea>
                <span class="form-hint">å¦‚å§“åèˆ‡ Timesheet é‡è¤‡ï¼Œä»¥ Timesheet ç‚ºä¸»ï¼ˆé‡è¤‡è€…å°‡é¡¯ç¤ºæ–¼æ’é™¤æ¸…å–®ï¼‰</span>
            </div>

            <div id="excludedSection" class="hidden" style="margin-top: 12px; padding: 12px 16px; background: #fff5f5; border: 1px solid #fed7d7; border-radius: 8px; font-size: 13px; color: #c53030;">
                <strong>ä»¥ä¸‹è‡ªè¨‚åå–®å§“åèˆ‡ Timesheet é‡è¤‡ï¼Œå·²æ’é™¤ï¼ˆä»¥ Timesheet ç‚ºä¸»ï¼‰ï¼š</strong>
                <span id="excludedNames"></span>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="runComparison()">é–‹å§‹æ¯”è¼ƒ</button>
            </div>
        </div>

        <!-- Step 2: Comparison Result -->
        <div id="resultSection" class="section hidden">
            <h2>æ­¥é©ŸäºŒï¼šæ¯”è¼ƒçµæœç¢ºèª</h2>

            <div id="summaryCards" class="summary-cards"></div>

            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#fed7d7;"></div><span>Timesheet è¼ƒæ—©</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#c6f6d5;"></div><span>A&amp;C è¼ƒæ—©</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#fefcbf;"></div><span>ç›¸åŒæ—¥æœŸ</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#e9d8fd;"></div><span>è‡ªè¨‚åå–®</span></div>
            </div>
            <p style="font-size:13px; color:#718096; margin-bottom:10px;">è¦å®šç”Ÿæ•ˆæ—¥ï¼š<strong>2025/07/01</strong>ã€€â€”ã€€å­°æ—©æ—¥æœŸè‹¥åœ¨ç”Ÿæ•ˆæ—¥ä¹‹å‰ï¼Œæœ€çµ‚ç°½ç½²æ—¥æœŸå°‡æ”¹å£“ 2025/07/01</p>

            <div class="table-wrapper">
                <table id="resultTable" class="result-table"></table>
            </div>

            <div class="btn-group">
                <button class="btn btn-green" onclick="confirmAndGenerate()">ç¢ºèªï¼Œç”¢ç”Ÿè²æ˜è¡¨æ ¼</button>
            </div>
        </div>

        <!-- Step 3: Final Word Table -->
        <div id="finalSection" class="section hidden">
            <h2>æ­¥é©Ÿä¸‰ï¼šè²æ˜è¡¨æ ¼ï¼ˆè¤‡è£½åˆ° Wordï¼‰</h2>

            <div class="word-table">
                <div class="table-wrapper">
                    <table id="finalTable"></table>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-copy" id="copyBtn" onclick="copyFinalTable()">ä¸€éµè¤‡è£½è¡¨æ ¼</button>
                <button class="btn btn-green" onclick="exportFinalExcel()">åŒ¯å‡º Excel</button>
            </div>
            <p style="margin-top: 12px; font-size: 13px; color: #718096; text-align: center;">
                æ–¼ Word è²¼ä¸Šè¡¨æ ¼æ™‚ï¼Œè«‹æŒ‰è²¼ä¸ŠæŒ‰éˆ•ä¸‹æ–¹ã€Œ<strong>V</strong>ã€ï¼Œä¸¦é¸æ“‡å·¦é‚Šç¬¬ä¸€å€‹ã€Œ<strong>ä¿ç•™ä¾†æºæ ¼å¼è¨­å®š</strong>ã€
            </p>
        </div>
    </div>

    <script>
        // ========== State ==========
        let parsedPeople = {}; // { name: earliestDate }

        // ========== Upload ==========
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault(); uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            if (!/\.(xlsx|xls)$/i.test(file.name)) { alert('è«‹ä¸Šå‚³ .xlsx æˆ– .xls æ ¼å¼çš„æª”æ¡ˆ'); return; }

            document.getElementById('fileName').textContent = file.name;
            uploadArea.classList.add('hidden');
            document.getElementById('fileInfo').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = e => {
                const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                parseWorkbook(wb);
            };
            reader.readAsArrayBuffer(file);
        }

        function resetAll() {
            parsedPeople = {};
            fileInput.value = '';
            uploadArea.classList.remove('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('finalSection').classList.add('hidden');
        }

        // ========== Parse ==========
        function parseWorkbook(wb) {
            // Read Sheet1
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', dateNF: 'yyyy-mm-dd' });

            if (rows.length < 2) { alert('Sheet1 è³‡æ–™ä¸è¶³'); return; }

            // Find header row (first row)
            const headers = rows[0].map(h => String(h).trim());

            // Find "Staff Name" and "Timesheet Date" columns
            const nameIdx = headers.findIndex(h => /staff\s*name/i.test(h));
            const dateIdx = headers.findIndex(h => /timesheet\s*date/i.test(h));

            if (nameIdx === -1) { alert('æ‰¾ä¸åˆ° "Staff Name" æ¬„ä½ï¼Œè«‹ç¢ºèª Sheet1 æ¨™é¡Œåˆ—'); return; }
            if (dateIdx === -1) { alert('æ‰¾ä¸åˆ° "Timesheet Date" æ¬„ä½ï¼Œè«‹ç¢ºèª Sheet1 æ¨™é¡Œåˆ—'); return; }

            // Group by name â†’ find earliest date
            parsedPeople = {};
            let totalRows = 0;

            for (let r = 1; r < rows.length; r++) {
                const row = rows[r];
                const name = row[nameIdx] != null ? String(row[nameIdx]).trim() : '';
                if (!name) continue;

                const dateVal = parseDate(row[dateIdx]);
                if (!dateVal) continue;

                totalRows++;
                if (!parsedPeople[name] || dateVal < parsedPeople[name]) {
                    parsedPeople[name] = dateVal;
                }
            }

            const peopleCount = Object.keys(parsedPeople).length;
            document.getElementById('parsedCount').textContent = `${peopleCount} äºº / ${totalRows} ç­†`;
            document.getElementById('parsedInfo').innerHTML =
                `<strong>å·¥ä½œè¡¨ï¼š</strong>${esc(sheetName)}ã€€|ã€€` +
                `<strong>Staff Name æ¬„ä½ï¼š</strong>ç¬¬ ${nameIdx + 1} æ¬„ (${esc(headers[nameIdx])})ã€€|ã€€` +
                `<strong>Timesheet Date æ¬„ä½ï¼š</strong>ç¬¬ ${dateIdx + 1} æ¬„ (${esc(headers[dateIdx])})ã€€|ã€€` +
                `<strong>è§£æçµæœï¼š</strong>${peopleCount} ä½ä¸åŒäººå“¡ï¼Œå…± ${totalRows} ç­†è¨˜éŒ„`;

            // Preview table (first 30 rows, relevant columns only)
            let previewHtml = '<table><thead><tr><th>åˆ—</th><th>Staff Name</th><th>Timesheet Date</th></tr></thead><tbody>';
            const previewEnd = Math.min(31, rows.length);
            for (let r = 1; r < previewEnd; r++) {
                const row = rows[r];
                const n = row[nameIdx] != null ? String(row[nameIdx]).trim() : '';
                const d = formatCellValue(row[dateIdx]);
                previewHtml += `<tr><td>${r + 1}</td><td>${esc(n)}</td><td>${esc(d)}</td></tr>`;
            }
            if (rows.length > previewEnd) {
                previewHtml += `<tr><td colspan="3" style="text-align:center;color:#999;font-style:italic;">... é‚„æœ‰ ${rows.length - previewEnd} åˆ— ...</td></tr>`;
            }
            previewHtml += '</tbody></table>';
            document.getElementById('previewContainer').innerHTML = previewHtml;
            document.getElementById('previewSection').classList.remove('hidden');
        }

        // ========== Comparison ==========
        const EFFECTIVE_DATE = new Date(2025, 6, 1); // 2025/07/01

        function runComparison() {
            const acDateStr = document.getElementById('acDateInput').value;
            if (!acDateStr) { alert('è«‹é¸æ“‡ A&C å®Œæˆæ—¥'); return; }
            if (Object.keys(parsedPeople).length === 0 && !document.getElementById('customNamesInput').value.trim()) {
                alert('è«‹å…ˆä¸Šå‚³ Timesheet Excelï¼Œæˆ–è¼¸å…¥è‡ªè¨‚åå–®'); return;
            }

            const acDate = new Date(acDateStr + 'T00:00:00');
            const results = [];
            const excludedNames = [];

            // 1. Timesheet people
            const tsNames = new Set();
            for (const [name, firstDate] of Object.entries(parsedPeople)) {
                tsNames.add(name);
                const ts = firstDate.getTime();
                const ac = acDate.getTime();

                let comparison, compClass, earlierDate;
                if (ts < ac) {
                    comparison = 'Timesheet è¼ƒæ—©'; compClass = 'earlier-timesheet'; earlierDate = firstDate;
                } else if (ts > ac) {
                    comparison = 'A&C è¼ƒæ—©'; compClass = 'earlier-ac'; earlierDate = acDate;
                } else {
                    comparison = 'ç›¸åŒæ—¥æœŸ'; compClass = 'same-date'; earlierDate = acDate;
                }

                // Check against effective date
                const beforeEffective = earlierDate < EFFECTIVE_DATE;
                const finalDate = beforeEffective ? EFFECTIVE_DATE : earlierDate;

                results.push({
                    name, source: 'Timesheet', firstDate, acDate, comparison, compClass,
                    earlierDate, beforeEffective, finalDate
                });
            }

            // 2. Custom names
            const customInput = document.getElementById('customNamesInput').value.trim();
            if (customInput) {
                const customNames = customInput.split(/[,ï¼Œã€\n]+/).map(s => s.trim()).filter(s => s);
                for (const name of customNames) {
                    if (tsNames.has(name)) {
                        excludedNames.push(name);
                        continue;
                    }
                    const earlierDate = acDate;
                    const beforeEffective = earlierDate < EFFECTIVE_DATE;
                    const finalDate = beforeEffective ? EFFECTIVE_DATE : earlierDate;
                    results.push({
                        name, source: 'è‡ªè¨‚åå–®', firstDate: null, acDate,
                        comparison: 'è‡ªè¨‚åå–®ï¼ˆå£“ A&C æ—¥æœŸï¼‰', compClass: 'custom-row',
                        earlierDate, beforeEffective, finalDate
                    });
                }
            }

            // Show excluded names
            const excludedSection = document.getElementById('excludedSection');
            if (excludedNames.length > 0) {
                document.getElementById('excludedNames').textContent = excludedNames.join('ã€');
                excludedSection.classList.remove('hidden');
            } else {
                excludedSection.classList.add('hidden');
            }

            displayResults(results);
        }

        function displayResults(results) {
            const total = results.length;
            const tsEarlier = results.filter(r => r.compClass === 'earlier-timesheet').length;
            const acEarlier = results.filter(r => r.compClass === 'earlier-ac').length;
            const same = results.filter(r => r.compClass === 'same-date').length;
            const custom = results.filter(r => r.compClass === 'custom-row').length;
            const adjusted = results.filter(r => r.beforeEffective).length;

            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card blue"><div class="number">${total}</div><div class="label">ç¸½äººæ•¸</div></div>
                <div class="summary-card red"><div class="number">${tsEarlier}</div><div class="label">Timesheet è¼ƒæ—©</div></div>
                <div class="summary-card green"><div class="number">${acEarlier}</div><div class="label">A&amp;C è¼ƒæ—©</div></div>
                <div class="summary-card yellow"><div class="number">${same}</div><div class="label">ç›¸åŒæ—¥æœŸ</div></div>
                <div class="summary-card purple"><div class="number">${custom}</div><div class="label">è‡ªè¨‚åå–®</div></div>
            `;

            let html = `<thead><tr>
                <th>#</th><th>å§“å</th><th>ä¾†æº</th><th>Timesheet ç¬¬ä¸€å¤©</th>
                <th>A&amp;C å®Œæˆæ—¥</th><th>ä½•è€…è¼ƒæ—©?</th><th>å­°æ—©æ—¥æœŸ</th>
                <th>èˆ‡è¦å®šç”Ÿæ•ˆæ—¥æ¯”è¼ƒ</th><th>æœ€çµ‚æ±ºå®šç°½ç½²æ—¥æœŸ</th>
            </tr></thead><tbody>`;

            results.forEach((r, i) => {
                const effectiveNote = r.beforeEffective
                    ? '<span style="color:#c53030;">ç”Ÿæ•ˆæ—¥å‰ â†’ æ”¹å£“ 07/01</span>'
                    : '<span style="color:#276749;">ç”Ÿæ•ˆæ—¥å¾Œï¼ˆä¸èª¿æ•´ï¼‰</span>';
                html += `<tr class="${r.compClass}">
                    <td>${i + 1}</td>
                    <td>${esc(r.name)}</td>
                    <td>${r.source}</td>
                    <td>${r.firstDate ? fmtDate(r.firstDate) : '-'}</td>
                    <td>${fmtDate(r.acDate)}</td>
                    <td>${r.comparison}</td>
                    <td>${fmtDate(r.earlierDate)}</td>
                    <td>${effectiveNote}</td>
                    <td><strong>${fmtDate(r.finalDate)}</strong></td>
                </tr>`;
            });
            html += '</tbody>';

            document.getElementById('resultTable').innerHTML = html;
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('finalSection').classList.add('hidden');
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            window._results = results;
        }

        // ========== Final Word Table ==========
        function confirmAndGenerate() {
            if (!window._results || window._results.length === 0) return;

            // 5.33cm â‰ˆ 201px (at 96dpi: 5.33*37.8), 1.66cm â‰ˆ 63px
            const CW = 201; const RH = 63;
            let html = `<thead><tr height="${RH}">
                <th width="${CW}" height="${RH}">è²æ˜äººå§“å</th><th width="${CW}" height="${RH}">ç°½ç« </th><th width="${CW}" height="${RH}">æ—¥æœŸ</th>
            </tr></thead><tbody>`;

            window._results.forEach(r => {
                html += `<tr height="${RH}">
                    <td width="${CW}" height="${RH}">${esc(r.name)}</td>
                    <td width="${CW}" height="${RH}"></td>
                    <td width="${CW}" height="${RH}">${fmtDate(r.finalDate)}</td>
                </tr>`;
            });
            html += '</tbody>';

            document.getElementById('finalTable').innerHTML = html;
            document.getElementById('finalSection').classList.remove('hidden');
            document.getElementById('copyBtn').textContent = 'ä¸€éµè¤‡è£½è¡¨æ ¼';
            document.getElementById('copyBtn').classList.remove('copied');
            document.getElementById('finalSection').scrollIntoView({ behavior: 'smooth' });
        }

        function copyFinalTable() {
            const table = document.getElementById('finalTable');
            const range = document.createRange();
            range.selectNode(table);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            try {
                document.execCommand('copy');
                const btn = document.getElementById('copyBtn');
                btn.textContent = 'å·²è¤‡è£½!';
                btn.classList.add('copied');
                setTimeout(() => { btn.textContent = 'ä¸€éµè¤‡è£½è¡¨æ ¼'; btn.classList.remove('copied'); }, 2000);
            } catch (e) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¡¨æ ¼å¾Œè¤‡è£½');
            }
            sel.removeAllRanges();
        }

        function exportFinalExcel() {
            if (!window._results) return;
            const data = [['è²æ˜äººå§“å', 'ç°½ç« ', 'æ—¥æœŸ']];
            window._results.forEach(r => { data.push([r.name, '', fmtDate(r.finalDate)]); });
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            ws['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 14 }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è²æ˜è¡¨æ ¼');
            XLSX.writeFile(wb, 'åˆ©å®³é—œä¿‚è²æ˜è¡¨æ ¼.xlsx');
        }

        // ========== Utilities ==========
        function parseDate(val) {
            if (val == null || val === '') return null;
            if (val instanceof Date) return isNaN(val.getTime()) ? null : val;
            const s = String(val).trim();
            // yyyy/mm/dd or yyyy-mm-dd
            let m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            if (m) return new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]));
            // Excel serial number
            if (/^\d{5}(\.\d+)?$/.test(s)) {
                const num = parseFloat(s);
                if (num > 30000 && num < 60000) return new Date((num - 25569) * 86400 * 1000);
            }
            // mm/dd/yyyy
            m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
            if (m) return new Date(parseInt(m[3]), parseInt(m[1]) - 1, parseInt(m[2]));
            const d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        }

        function fmtDate(d) {
            if (!d || !(d instanceof Date)) return '';
            return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
        }

        function formatCellValue(val) {
            if (val == null) return '';
            if (val instanceof Date) return fmtDate(val);
            return String(val);
        }

        function esc(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }
    </script>
</body>
</html>
