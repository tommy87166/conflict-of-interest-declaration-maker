<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet æ¯”è¼ƒå·¥å…·</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Noto Sans TC", sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        h1 {
            text-align: center;
            color: #1a365d;
            margin-bottom: 8px;
            font-size: 28px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 32px;
            font-size: 14px;
        }

        /* Upload Area */
        .upload-area {
            background: #fff;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 24px;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #4299e1;
            background: #ebf8ff;
        }
        .upload-area .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        .upload-area p {
            font-size: 16px;
            color: #666;
        }
        .upload-area .hint {
            font-size: 13px;
            color: #999;
            margin-top: 8px;
        }
        input[type="file"] { display: none; }

        /* File Info */
        .file-info {
            background: #fff;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-info .name {
            font-weight: 600;
            color: #2d3748;
        }
        .file-info .btn-reupload {
            background: #e2e8f0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .file-info .btn-reupload:hover { background: #cbd5e0; }

        /* Section */
        .section {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        /* Sheet Tabs */
        .sheet-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .sheet-tab {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            background: #fff;
            transition: all 0.2s;
        }
        .sheet-tab:hover { background: #ebf8ff; border-color: #4299e1; }
        .sheet-tab.active {
            background: #4299e1;
            color: #fff;
            border-color: #4299e1;
        }

        /* Config */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .config-item label {
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
        }
        .config-item select, .config-item input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        .config-item select:focus, .config-item input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66,153,225,0.2);
        }
        .config-hint {
            font-size: 12px;
            color: #999;
            margin-top: -8px;
            margin-bottom: 12px;
        }

        /* Buttons */
        .btn-primary {
            background: #4299e1;
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-primary:hover { background: #3182ce; }
        .btn-primary:disabled { background: #a0aec0; cursor: not-allowed; }

        .btn-secondary {
            background: #48bb78;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-secondary:hover { background: #38a169; }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px 14px;
            text-align: left;
            border: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        th {
            background: #edf2f7;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) { background: #f7fafc; }
        tr:hover { background: #ebf8ff; }

        .result-table th {
            background: #2d3748;
            color: #fff;
        }
        .result-table .earlier-timesheet { background: #fed7d7; }
        .result-table .earlier-ac { background: #c6f6d5; }
        .result-table .same-date { background: #fefcbf; }

        /* Preview table */
        .preview-container {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .preview-container table {
            font-size: 13px;
        }

        /* Summary */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .summary-card .number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .summary-card .label {
            font-size: 14px;
            color: #666;
        }
        .summary-card.red .number { color: #e53e3e; }
        .summary-card.green .number { color: #38a169; }
        .summary-card.yellow .number { color: #d69e2e; }
        .summary-card.blue .number { color: #3182ce; }

        /* Legend */
        .legend {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .hidden { display: none; }

        /* Header row selector */
        .header-row-config {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .header-row-config label {
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
        }
        .header-row-config input {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        .header-row-config .hint {
            font-size: 12px;
            color: #999;
        }

        /* Timesheet date columns selector */
        .date-columns-section {
            margin-top: 16px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .date-columns-section h3 {
            font-size: 15px;
            margin-bottom: 12px;
            color: #2d3748;
        }
        .date-col-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
        }
        .date-col-chip {
            padding: 4px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            background: #fff;
            transition: all 0.2s;
            user-select: none;
        }
        .date-col-chip:hover { border-color: #4299e1; }
        .date-col-chip.selected {
            background: #4299e1;
            color: #fff;
            border-color: #4299e1;
        }
        .select-actions {
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
        }
        .select-actions button {
            padding: 4px 12px;
            font-size: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            font-family: inherit;
        }
        .select-actions button:hover { background: #edf2f7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Timesheet æ—¥æœŸæ¯”è¼ƒå·¥å…·</h1>
        <p class="subtitle">ä¸Šå‚³ Timesheet Excel æª”æ¡ˆï¼Œæ¯”è¼ƒæ¯äººå¡«å¯« Timesheet çš„ç¬¬ä¸€å¤©èˆ‡ A&C å®Œæˆæ—¥</p>

        <!-- Upload -->
        <div id="uploadArea" class="upload-area">
            <div class="icon">ğŸ“‚</div>
            <p>é»æ“Šæˆ–æ‹–æ›³ Excel æª”æ¡ˆåˆ°æ­¤è™•</p>
            <p class="hint">æ”¯æ´ .xlsx, .xls æ ¼å¼</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
        </div>

        <!-- File Info -->
        <div id="fileInfo" class="file-info hidden">
            <span class="name" id="fileName"></span>
            <button class="btn-reupload" onclick="resetAll()">é‡æ–°ä¸Šå‚³</button>
        </div>

        <!-- Sheet Selection -->
        <div id="sheetSection" class="section hidden">
            <h2>1. é¸æ“‡å·¥ä½œè¡¨</h2>
            <div id="sheetTabs" class="sheet-tabs"></div>
        </div>

        <!-- Header Row Config -->
        <div id="headerSection" class="section hidden">
            <h2>2. è¨­å®šæ¨™é¡Œåˆ—</h2>
            <div class="header-row-config">
                <label>æ¨™é¡Œåˆ—ä½æ–¼ç¬¬</label>
                <input type="number" id="headerRowInput" min="1" value="1">
                <label>åˆ—</label>
                <span class="hint">ï¼ˆè³‡æ–™å¾æ¨™é¡Œåˆ—çš„ä¸‹ä¸€åˆ—é–‹å§‹ï¼‰</span>
                <button class="btn-primary" style="padding: 8px 16px; font-size: 14px; margin-left: auto;" onclick="applyHeaderRow()">å¥—ç”¨</button>
            </div>

            <!-- Preview -->
            <h3 style="margin: 16px 0 8px; font-size: 15px; color: #4a5568;">è³‡æ–™é è¦½</h3>
            <div id="previewContainer" class="preview-container"></div>
        </div>

        <!-- Column Mapping -->
        <div id="configSection" class="section hidden">
            <h2>3. æ¬„ä½å°æ‡‰</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label>å§“åæ¬„ä½</label>
                    <select id="nameCol"></select>
                </div>
                <div class="config-item">
                    <label>A&C å®Œæˆæ—¥æ¬„ä½</label>
                    <select id="acDateCol"></select>
                </div>
            </div>

            <div class="date-columns-section">
                <h3>Timesheet æ—¥æœŸæ¬„ä½ï¼ˆé»é¸è¦ç´å…¥æ¯”è¼ƒçš„æ—¥æœŸæ¬„ä½ï¼‰</h3>
                <div class="select-actions">
                    <button onclick="selectAllDateCols()">å…¨é¸</button>
                    <button onclick="deselectAllDateCols()">å…¨ä¸é¸</button>
                    <button onclick="autoSelectDateCols()">è‡ªå‹•åµæ¸¬æ—¥æœŸæ¬„</button>
                </div>
                <div id="dateColChips" class="date-col-chips"></div>
            </div>

            <div class="btn-group">
                <button class="btn-primary" onclick="runComparison()">é–‹å§‹æ¯”è¼ƒ</button>
            </div>
        </div>

        <!-- Results -->
        <div id="resultSection" class="section hidden">
            <h2>4. æ¯”è¼ƒçµæœ</h2>

            <div id="summaryCards" class="summary-cards"></div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background:#fed7d7;"></div>
                    <span>Timesheet ç¬¬ä¸€å¤©è¼ƒæ—©ï¼ˆå…ˆå¡« Timesheetï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#c6f6d5;"></div>
                    <span>A&C å®Œæˆæ—¥è¼ƒæ—©ï¼ˆå…ˆå®Œæˆ A&Cï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#fefcbf;"></div>
                    <span>å…©è€…ç›¸åŒæ—¥æœŸ</span>
                </div>
            </div>

            <div class="table-wrapper">
                <table id="resultTable" class="result-table"></table>
            </div>

            <div class="btn-group">
                <button class="btn-secondary" onclick="exportResult()">åŒ¯å‡ºçµæœ (Excel)</button>
                <button class="btn-secondary" onclick="copyTable()">è¤‡è£½è¡¨æ ¼</button>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let currentSheet = null;
        let sheetData = [];
        let headers = [];
        let headerRowIndex = 0; // 0-based
        let selectedDateCols = new Set();

        // ========== Upload ==========
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!/\.(xlsx|xls)$/i.test(file.name)) {
                alert('è«‹ä¸Šå‚³ .xlsx æˆ– .xls æ ¼å¼çš„æª”æ¡ˆ');
                return;
            }
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('fileInfo').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = e => {
                workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                showSheetTabs();
            };
            reader.readAsArrayBuffer(file);
        }

        function resetAll() {
            workbook = null;
            currentSheet = null;
            sheetData = [];
            headers = [];
            selectedDateCols = new Set();
            fileInput.value = '';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('sheetSection').classList.add('hidden');
            document.getElementById('headerSection').classList.add('hidden');
            document.getElementById('configSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
        }

        // ========== Sheet Tabs ==========
        function showSheetTabs() {
            const container = document.getElementById('sheetTabs');
            container.innerHTML = '';
            workbook.SheetNames.forEach((name, i) => {
                const tab = document.createElement('button');
                tab.className = 'sheet-tab' + (i === 0 ? ' active' : '');
                tab.textContent = name;
                tab.onclick = () => selectSheet(name, tab);
                container.appendChild(tab);
            });
            document.getElementById('sheetSection').classList.remove('hidden');
            selectSheet(workbook.SheetNames[0], container.firstChild);
        }

        function selectSheet(name, tabEl) {
            document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');
            currentSheet = name;
            document.getElementById('headerRowInput').value = 1;
            headerRowIndex = 0;
            parseSheet();
        }

        function parseSheet() {
            const ws = workbook.Sheets[currentSheet];
            // Get raw array (array of arrays), keeping empty cells
            const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false, dateNF: 'yyyy-mm-dd' });

            if (rawData.length === 0) {
                alert('æ­¤å·¥ä½œè¡¨ç„¡è³‡æ–™');
                return;
            }

            // Also get with dates preserved
            const rawDataWithDates = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', dateNF: 'yyyy-mm-dd' });

            sheetData = rawDataWithDates;
            applyHeaderRow();
        }

        function applyHeaderRow() {
            const rowNum = parseInt(document.getElementById('headerRowInput').value) || 1;
            headerRowIndex = rowNum - 1;

            if (headerRowIndex >= sheetData.length) {
                alert('æ¨™é¡Œåˆ—è¶…å‡ºè³‡æ–™ç¯„åœ');
                return;
            }

            // Extract headers from the specified row
            headers = sheetData[headerRowIndex].map((h, i) => {
                if (h === '' || h === null || h === undefined) return `(æ¬„${i + 1})`;
                if (h instanceof Date) return formatDate(h);
                return String(h).trim();
            });

            showPreview();
            setupColumnMapping();

            document.getElementById('headerSection').classList.remove('hidden');
            document.getElementById('configSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
        }

        // ========== Preview ==========
        function showPreview() {
            const container = document.getElementById('previewContainer');
            let html = '<table><thead><tr>';
            headers.forEach((h, i) => {
                const isHeader = true;
                html += `<th title="æ¬„ ${i + 1}">${escapeHtml(h)}</th>`;
            });
            html += '</tr></thead><tbody>';

            const dataStart = headerRowIndex + 1;
            const previewEnd = Math.min(dataStart + 20, sheetData.length);
            for (let r = dataStart; r < previewEnd; r++) {
                html += '<tr>';
                for (let c = 0; c < headers.length; c++) {
                    const val = sheetData[r] ? sheetData[r][c] : '';
                    html += `<td>${escapeHtml(formatCellValue(val))}</td>`;
                }
                html += '</tr>';
            }
            if (sheetData.length > previewEnd) {
                html += `<tr><td colspan="${headers.length}" style="text-align:center;color:#999;font-style:italic;">... é‚„æœ‰ ${sheetData.length - previewEnd} åˆ—è³‡æ–™ ...</td></tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ========== Column Mapping ==========
        function setupColumnMapping() {
            const nameSelect = document.getElementById('nameCol');
            const acSelect = document.getElementById('acDateCol');

            // Build options
            let options = '<option value="">-- è«‹é¸æ“‡ --</option>';
            headers.forEach((h, i) => {
                options += `<option value="${i}">${escapeHtml(h)}</option>`;
            });
            nameSelect.innerHTML = options;
            acSelect.innerHTML = options;

            // Auto-detect name column
            const namePatterns = ['å§“å', 'åå­—', 'name', 'äººå“¡', 'å“¡å·¥', 'å¡«è¡¨äºº', 'ç”³å ±äºº'];
            for (let i = 0; i < headers.length; i++) {
                const h = headers[i].toLowerCase();
                if (namePatterns.some(p => h.includes(p.toLowerCase()))) {
                    nameSelect.value = i;
                    break;
                }
            }

            // Auto-detect A&C date column
            const acPatterns = ['a&c', 'acå®Œæˆ', 'a&cå®Œæˆ', 'å®Œæˆæ—¥', 'completion', 'ac date', 'a&c date'];
            for (let i = 0; i < headers.length; i++) {
                const h = headers[i].toLowerCase();
                if (acPatterns.some(p => h.includes(p.toLowerCase()))) {
                    acSelect.value = i;
                    break;
                }
            }

            // Setup date column chips
            setupDateColumnChips();
        }

        function setupDateColumnChips() {
            const container = document.getElementById('dateColChips');
            container.innerHTML = '';
            selectedDateCols = new Set();

            headers.forEach((h, i) => {
                const chip = document.createElement('span');
                chip.className = 'date-col-chip';
                chip.textContent = h;
                chip.dataset.index = i;
                chip.onclick = () => toggleDateCol(chip, i);
                container.appendChild(chip);
            });

            // Auto-select date columns
            autoSelectDateCols();
        }

        function toggleDateCol(chip, index) {
            if (selectedDateCols.has(index)) {
                selectedDateCols.delete(index);
                chip.classList.remove('selected');
            } else {
                selectedDateCols.add(index);
                chip.classList.add('selected');
            }
        }

        function selectAllDateCols() {
            const chips = document.querySelectorAll('.date-col-chip');
            chips.forEach(chip => {
                const i = parseInt(chip.dataset.index);
                selectedDateCols.add(i);
                chip.classList.add('selected');
            });
        }

        function deselectAllDateCols() {
            const chips = document.querySelectorAll('.date-col-chip');
            chips.forEach(chip => {
                selectedDateCols.delete(parseInt(chip.dataset.index));
                chip.classList.remove('selected');
            });
        }

        function autoSelectDateCols() {
            const chips = document.querySelectorAll('.date-col-chip');
            const nameIdx = parseInt(document.getElementById('nameCol').value);
            const acIdx = parseInt(document.getElementById('acDateCol').value);

            selectedDateCols.clear();
            chips.forEach(chip => {
                const i = parseInt(chip.dataset.index);
                chip.classList.remove('selected');

                // Skip name and AC columns
                if (i === nameIdx || i === acIdx) return;

                const h = headers[i];
                // Check if header looks like a date
                if (isDateLike(h) || isDateHeader(h, i)) {
                    selectedDateCols.add(i);
                    chip.classList.add('selected');
                }
            });
        }

        function isDateLike(val) {
            if (val instanceof Date) return true;
            if (typeof val !== 'string') return false;
            const s = val.trim();
            // Match patterns like: 2024/01/15, 2024-01-15, 01/15, 1/15, 1æœˆ15æ—¥, etc.
            if (/^\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2}$/.test(s)) return true;
            if (/^\d{1,2}[\/\-\.]\d{1,2}([\/\-\.]\d{2,4})?$/.test(s)) return true;
            if (/^\d{1,2}æœˆ\d{1,2}æ—¥?$/.test(s)) return true;
            if (/^\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥$/.test(s)) return true;
            // Excel serial date number
            if (/^\d{5}$/.test(s)) return true;
            return false;
        }

        function isDateHeader(header, colIndex) {
            // Check a few data rows to see if this column contains dates
            const dataStart = headerRowIndex + 1;
            let dateCount = 0;
            let totalChecked = 0;
            for (let r = dataStart; r < Math.min(dataStart + 10, sheetData.length); r++) {
                if (sheetData[r] && sheetData[r][colIndex] != null && sheetData[r][colIndex] !== '') {
                    totalChecked++;
                    const val = sheetData[r][colIndex];
                    if (val instanceof Date || isDateLike(String(val))) {
                        dateCount++;
                    }
                }
            }
            return totalChecked > 0 && (dateCount / totalChecked) > 0.5;
        }

        // ========== Comparison ==========
        function runComparison() {
            const nameColIdx = parseInt(document.getElementById('nameCol').value);
            const acColIdx = parseInt(document.getElementById('acDateCol').value);

            if (isNaN(nameColIdx)) {
                alert('è«‹é¸æ“‡å§“åæ¬„ä½');
                return;
            }
            if (isNaN(acColIdx)) {
                alert('è«‹é¸æ“‡ A&C å®Œæˆæ—¥æ¬„ä½');
                return;
            }
            if (selectedDateCols.size === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ Timesheet æ—¥æœŸæ¬„ä½');
                return;
            }

            const dataStart = headerRowIndex + 1;
            const results = [];

            // Get sorted date column indices
            const dateColIndices = Array.from(selectedDateCols).sort((a, b) => a - b);

            // Parse each date column header as a date
            const dateColDates = dateColIndices.map(i => ({
                index: i,
                header: headers[i],
                date: parseDate(headers[i])
            }));

            for (let r = dataStart; r < sheetData.length; r++) {
                const row = sheetData[r];
                if (!row) continue;

                const name = row[nameColIdx];
                if (!name || String(name).trim() === '') continue;

                // Get A&C date
                const acDateRaw = row[acColIdx];
                const acDate = parseDate(acDateRaw);

                // Find first timesheet date (earliest date column where this person has data)
                let firstTimesheetDate = null;
                let firstTimesheetHeader = '';

                // Strategy 1: Date columns have date headers - find earliest with data
                // Strategy 2: Date columns contain the date values themselves
                // Try both strategies

                // Check if column headers are dates
                const headersAreDates = dateColDates.some(d => d.date !== null);

                if (headersAreDates) {
                    // Headers are dates - find the earliest date column where this person has a non-empty value
                    const colsWithDates = dateColDates
                        .filter(d => d.date !== null)
                        .sort((a, b) => a.date - b.date);

                    for (const col of colsWithDates) {
                        const cellVal = row[col.index];
                        if (cellVal !== null && cellVal !== undefined && cellVal !== '' && cellVal !== 0) {
                            firstTimesheetDate = col.date;
                            firstTimesheetHeader = col.header;
                            break;
                        }
                    }
                } else {
                    // Headers are not dates - look for date values in the cells
                    for (const colIdx of dateColIndices) {
                        const cellVal = row[colIdx];
                        const cellDate = parseDate(cellVal);
                        if (cellDate !== null) {
                            if (firstTimesheetDate === null || cellDate < firstTimesheetDate) {
                                firstTimesheetDate = cellDate;
                                firstTimesheetHeader = headers[colIdx];
                            }
                        }
                    }
                }

                let comparison = '';
                let compClass = '';
                let earlierDate = null;

                if (firstTimesheetDate && acDate) {
                    const tsTime = firstTimesheetDate.getTime();
                    const acTime = acDate.getTime();
                    if (tsTime < acTime) {
                        comparison = 'Timesheet è¼ƒæ—©';
                        compClass = 'earlier-timesheet';
                        earlierDate = firstTimesheetDate;
                    } else if (tsTime > acTime) {
                        comparison = 'A&C è¼ƒæ—©';
                        compClass = 'earlier-ac';
                        earlierDate = acDate;
                    } else {
                        comparison = 'ç›¸åŒæ—¥æœŸ';
                        compClass = 'same-date';
                        earlierDate = acDate;
                    }
                } else if (firstTimesheetDate) {
                    comparison = 'ç¼ºå°‘ A&C æ—¥æœŸ';
                    compClass = '';
                    earlierDate = firstTimesheetDate;
                } else if (acDate) {
                    comparison = 'ç„¡ Timesheet è¨˜éŒ„';
                    compClass = '';
                    earlierDate = acDate;
                } else {
                    comparison = 'å…©è€…çš†ç„¡æ—¥æœŸ';
                    compClass = '';
                }

                results.push({
                    name: String(name).trim(),
                    firstTimesheetDate,
                    firstTimesheetHeader,
                    acDate,
                    acDateRaw: formatCellValue(acDateRaw),
                    comparison,
                    compClass,
                    earlierDate
                });
            }

            displayResults(results);
        }

        function displayResults(results) {
            // Summary
            const total = results.length;
            const tsEarlier = results.filter(r => r.compClass === 'earlier-timesheet').length;
            const acEarlier = results.filter(r => r.compClass === 'earlier-ac').length;
            const same = results.filter(r => r.compClass === 'same-date').length;

            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card blue">
                    <div class="number">${total}</div>
                    <div class="label">ç¸½äººæ•¸</div>
                </div>
                <div class="summary-card red">
                    <div class="number">${tsEarlier}</div>
                    <div class="label">Timesheet è¼ƒæ—©</div>
                </div>
                <div class="summary-card green">
                    <div class="number">${acEarlier}</div>
                    <div class="label">A&C è¼ƒæ—©</div>
                </div>
                <div class="summary-card yellow">
                    <div class="number">${same}</div>
                    <div class="label">ç›¸åŒæ—¥æœŸ</div>
                </div>
            `;

            // Table
            let html = `<thead><tr>
                <th>#</th>
                <th>å§“å</th>
                <th>Timesheet ç¬¬ä¸€å¤©</th>
                <th>A&C å®Œæˆæ—¥</th>
                <th>æ¯”è¼ƒçµæœ</th>
                <th>å­°æ—©è€…æ—¥æœŸ</th>
            </tr></thead><tbody>`;

            results.forEach((r, i) => {
                html += `<tr class="${r.compClass}">
                    <td>${i + 1}</td>
                    <td>${escapeHtml(r.name)}</td>
                    <td>${r.firstTimesheetDate ? formatDate(r.firstTimesheetDate) : '-'}</td>
                    <td>${r.acDate ? formatDate(r.acDate) : '-'}</td>
                    <td>${r.comparison}</td>
                    <td>${r.earlierDate ? formatDate(r.earlierDate) : '-'}</td>
                </tr>`;
            });

            html += '</tbody>';
            document.getElementById('resultTable').innerHTML = html;
            document.getElementById('resultSection').classList.remove('hidden');

            // Scroll to results
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            // Store for export
            window._results = results;
        }

        // ========== Export ==========
        function exportResult() {
            if (!window._results) return;

            const data = [['#', 'å§“å', 'Timesheet ç¬¬ä¸€å¤©', 'A&C å®Œæˆæ—¥', 'æ¯”è¼ƒçµæœ', 'å­°æ—©è€…æ—¥æœŸ']];
            window._results.forEach((r, i) => {
                data.push([
                    i + 1,
                    r.name,
                    r.firstTimesheetDate ? formatDate(r.firstTimesheetDate) : '',
                    r.acDate ? formatDate(r.acDate) : '',
                    r.comparison,
                    r.earlierDate ? formatDate(r.earlierDate) : ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'æ¯”è¼ƒçµæœ');
            XLSX.writeFile(wb, 'Timesheet_æ¯”è¼ƒçµæœ.xlsx');
        }

        function copyTable() {
            const table = document.getElementById('resultTable');
            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            alert('è¡¨æ ¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
        }

        // ========== Utilities ==========
        function parseDate(val) {
            if (val === null || val === undefined || val === '') return null;
            if (val instanceof Date) {
                return isNaN(val.getTime()) ? null : val;
            }

            const s = String(val).trim();

            // Excel serial date number
            if (/^\d{5}(\.\d+)?$/.test(s)) {
                const num = parseFloat(s);
                if (num > 30000 && num < 60000) {
                    const d = new Date((num - 25569) * 86400 * 1000);
                    return isNaN(d.getTime()) ? null : d;
                }
            }

            // yyyy/mm/dd or yyyy-mm-dd
            let m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            if (m) return new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]));

            // mm/dd/yyyy or dd/mm/yyyy - assume mm/dd/yyyy
            m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
            if (m) return new Date(parseInt(m[3]), parseInt(m[1]) - 1, parseInt(m[2]));

            // yyyyå¹´mmæœˆddæ—¥
            m = s.match(/^(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (m) return new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]));

            // mmæœˆddæ—¥
            m = s.match(/^(\d{1,2})æœˆ(\d{1,2})æ—¥?$/);
            if (m) {
                const now = new Date();
                return new Date(now.getFullYear(), parseInt(m[1]) - 1, parseInt(m[2]));
            }

            // Try native parse as last resort
            const d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        }

        function formatDate(d) {
            if (!d || !(d instanceof Date)) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}/${m}/${day}`;
        }

        function formatCellValue(val) {
            if (val === null || val === undefined) return '';
            if (val instanceof Date) return formatDate(val);
            return String(val);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
